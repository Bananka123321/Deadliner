{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/home_logged.css' %}">
  <script defer src="{% static 'js/home_logged.js' %}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard">
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üöÄ</div>
      <span class="logo-text">TaskFlow</span>
    </div>
    
    <nav class="menu">
      <ul>
        <li class="active"><i class="fas fa-users"></i> <span>–ì—Ä—É–ø–ø—ã</span></li>
        <li><i class="fas fa-tasks"></i> <span>–ó–∞–¥–∞—á–∏</span></li>
        <li><i class="fas fa-calendar-alt"></i> <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info dropdown">
        <div class="user-avatar">{{ user.username|slice:":1"|upper }}</div>
        <span class="username">{{ user.username }}</span>
        <div class="dropdown-menu">
          <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="logout-btn">–í—ã–π—Ç–∏</button>
          </form>
        </div>
      </div>
    </div>
  </aside>
  <main class="main-content">
    <header class="page-header">
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span class="highlight">{{ user.username }}</span></h1>
      <p class="subtitle">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á</p>
    </header>
    <div class="stats-grid">
      <div class="stat-card neon-success">
        <div class="stat-icon">‚úî</div>
        <div class="stat-details">
          <span class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
          <span class="stat-value" id="total-done">{{ total_done }}</span>
        </div>
      </div>

      <div class="stat-card neon-streak">
        <div class="stat-icon">üî•</div>
        <div class="stat-details">
          <span class="stat-label">–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫</span>
          <span class="stat-value" id="current-streak">{{ current_streak }}</span>
        </div>
      </div>

      <div class="stat-card neon-warning">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-details">
          <span class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
          <span class="stat-value" id="expired">{{ expired }}</span>
        </div>
      </div>
    </div>
    <div class="tasks-section">
      <div class="section-header">
        <h2>–í–∞—à–∏ –≥—Ä—É–ø–ø—ã</h2>
        <div class="actions">
          <button class="btn-primary" id="openTaskModal"><i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
        </div>
      </div>

      <div class="tasks-grid">
        {% for group, tasks in group_tasks.items %}
        <div class="task-group clickable" data-href="{% url 'group_detail' group.id %}" data-group-id="{{ group.id }}">
          <div class="group-header">
            <h3>{{ group.name }}</h3>
            <span class="task-count">{{ tasks|length }}</span>
          </div>

          <div class="tasks-list">
            {% for task in tasks %}
            <div class="task-item">
              <div class="task-content">
                <div class="task-title">{{ task.title }}</div>
                <div class="task-meta">
                  {% if task.discipline %}
                    <span class="discipline">{{ task.discipline }}</span>
                  {% endif %}
                  {% if task.deadline %}
                    <span class="deadline">
                      –¥–æ {{ task.deadline|date:"d.m.Y" }}
                    </span>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </main>
</div>

<div class="modal-overlay task-modal" id="taskModal">
  <div class="modal-content task-modal">
    <div class="modal-header">
      <h3><i class="fas fa-tasks"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
      <button class="modal-close" id="closeTaskModal">&times;</button>
    </div>

    <form method="post" action="{% url 'create_task' %}" id="taskForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ task_form.title.id_for_label }}"><i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
        {{ task_form.title }}
        {% if task_form.title.errors %}
          <div class="errorlist">{{ task_form.title.errors }}</div>
        {% endif %}
        <div class="help-text">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ª–∏ –∑–∞–¥–∞—á–∏</div>
      </div>

      <div class="form-group">
        <label for="{{ task_form.description.id_for_label }}"><i class="fas fa-align-left"></i> –û–ø–∏—Å–∞–Ω–∏–µ</label>
        {{ task_form.description }}
        {% if task_form.description.errors %}
          <div class="errorlist">{{ task_form.description.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ task_form.discipline.id_for_label }}"><i class="fas fa-book"></i> –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</label>
        {{ task_form.discipline }}
        {% if task_form.discipline.errors %}
          <div class="errorlist">{{ task_form.discipline.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ task_form.deadline.id_for_label }}"><i class="fas fa-calendar-check"></i> –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
        {{ task_form.deadline }}
        {% if task_form.deadline.errors %}
          <div class="errorlist">{{ task_form.deadline.errors }}</div>
        {% endif %}
        <div class="help-text">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î</div>
      </div>

      <div class="form-group">
        <label for="{{ task_form.group.id_for_label }}"><i class="fas fa-layer-group"></i> –ì—Ä—É–ø–ø–∞</label>
        {{ task_form.group }}
        {% if task_form.group.errors %}
          <div class="errorlist">{{ task_form.group.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ task_form.points.id_for_label }}"><i class="fas fa-star"></i> –ë–∞–ª–ª—ã –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
        {{ task_form.points }}
        {% if task_form.points.errors %}
          <div class="errorlist">{{ task_form.points.errors }}</div>
        {% endif %}
        <div class="help-text">–°–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –ø–æ–ª—É—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelTaskModal">
          <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" class="btn-primary">
          <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}