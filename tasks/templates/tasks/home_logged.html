{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/home_logged.css' %}">
  <script defer src="{% static 'js/home_logged.js' %}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard">
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üöÄ</div>
      <span class="logo-text">DeadLiner</span>
    </div>
    
    <nav class="menu">
      <ul>
        <li class="active" data-section="groups">
          <i class="fas fa-users"></i> <span>–ì—Ä—É–ø–ø—ã</span>
        </li>
        <li data-section="tasks">
          <i class="fas fa-tasks"></i> <span>–ó–∞–¥–∞—á–∏</span>
        </li>
        <li data-section="calendar">
          <i class="fas fa-calendar-alt"></i> <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info dropdown">
        <div class="user-avatar">{{ user.username|slice:":1"|upper }}</div>
        <span class="username">{{ user.username }}</span>
        <div class="dropdown-menu">
          <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="logout-btn">–í—ã–π—Ç–∏</button>
          </form>
        </div>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <header class="page-header">
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span class="highlight">{{ user.username }}</span></h1>
      <p class="subtitle">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á</p>
    </header>

    <div class="stats-grid">
        <div class="stat-card neon-success">
            <div class="stat-icon">üìä</div>
            <div class="stat-details">
                <span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á</span>
                <span class="stat-value">{{ progress_percent }}%</span>
                <div class="stat-progress-bar">
                    <div class="stat-progress-fill" style="width: {{ progress_percent }}%"></div>
                </div>
            </div>
        </div>

        <div class="stat-card rank-highlight">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-details">
                <span class="stat-label">–ú–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ</span>
                <span class="stat-value">#{{ rank }}</span>
                <span class="subtitle">—Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤</span>
            </div>
        </div>

        <div class="stat-card neon-streak">
            <div class="stat-icon">üî•</div>
            <div class="stat-details">
                <span class="stat-label">–°—Ç—Ä–∏–∫ –¥–Ω–µ–π</span>
                <span class="stat-value">{{ current_streak }}</span>
            </div>
        </div>

        <div class="stat-card neon-warning">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-details">
                <span class="stat-label">–ù—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å</span>
                <span class="stat-value">{{ total_pending }}</span>
            </div>
        </div>
    </div>

    <div class="content-container">
      <section id="groups-section" class="content-section active">
        <div class="section-wrapper">
          <div class="header">
            <h2>–í–∞—à–∏ –≥—Ä—É–ø–ø—ã</h2>
            <div class="actions">
              <button class="btn-primary" id="openGroupModal">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
              </button>
            </div>
          </div>

          <div class="tasks-grid">
            {% for group, tasks in group_tasks.items %}
            <div class="task-group clickable" data-href="{% url 'group_detail' group.id %}" data-group-id="{{ group.id }}">
              <div class="group-header">
                <h3>{{ group.name }}</h3>
                <span class="task-count">{{ tasks|length }}</span>
              </div>
              <div class="tasks-list">
                {% for task in tasks %}
                  <div class="task-item list-task-item" 
                      data-id="{{ task.id }}"
                      data-title="{{ task.title }}"
                      data-description="{{ task.description|default:'' }}"
                      data-discipline="{{ task.discipline|default:'' }}"
                      data-deadline="{{ task.deadline|date:'c' }}"
                      data-group="{{ group.name }}"
                      data-points="{{ task.points }}">
                    <div class="task-content">
                      <div class="task-title">{{ task.title }}</div>
                      <div class="task-meta">
                        {% if task.discipline %}
                          <span class="discipline">{{ task.discipline }}</span>
                        {% endif %}
                        {% if task.deadline %}
                          <span class="deadline">–¥–æ {{ task.deadline|date:"d.m.Y" }}</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
            
            {% if not group_tasks %}
            <div class="empty-state">
              <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </section>

      <section id="tasks-section" class="content-section">
        <div class="section-wrapper">
          <div class="section-header">
            <h2>–í—Å–µ –∑–∞–¥–∞—á–∏</h2>
            <div class="actions">
              <button class="btn-primary" id="openTaskModal">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
              </button>
            </div>
          </div>
          
          <div class="tasks-list-full">
            {% for group, tasks in group_tasks.items %}
              {% for task in tasks %}
              <div class="task-item list-task-item" 
                  data-id="{{ task.id }}"
                  data-title="{{ task.title }}"
                  data-description="{{ task.description|default:'' }}"
                  data-discipline="{{ task.discipline|default:'' }}"
                  data-deadline="{{ task.deadline|date:'c' }}"
                  data-group="{{ group.name }}"
                  data-points="{{ task.points }}">
                <div class="task-content">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta">
                    {% if task.discipline %}
                      <span class="discipline">{{ task.discipline }}</span>
                    {% endif %}
                    {% if task.deadline %}
                      <span class="deadline">–¥–æ {{ task.deadline|date:"d.m.Y" }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            {% endfor %}
            
            {% if not group_tasks %}
            <div class="empty-state">
              <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </section>

      <section id="calendar-section" class="content-section">
        <div class="section-wrapper">
          <div class="section-header">
            <h2><i class="fas fa-calendar-alt me-2"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞—á</h2>
            <div class="calendar-controls">
              <button class="calendar-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
              <h3 id="currentMonthYear" class="current-period">–ò—é–Ω—å 2026</h3>
              <button class="calendar-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
              <div class="view-toggle">
                <button class="view-btn active" data-view="month"><i class="fas fa-calendar-week"></i> –ú–µ—Å—è—Ü</button>
                <button class="view-btn" data-view="week"><i class="fas fa-calendar-day"></i> –ù–µ–¥–µ–ª—è</button>
              </div>
            </div>
          </div>
          
          <div class="calendar-container">
            <div class="calendar-header">
              <div class="calendar-day-header">–ü–Ω</div>
              <div class="calendar-day-header">–í—Ç</div>
              <div class="calendar-day-header">–°—Ä</div>
              <div class="calendar-day-header">–ß—Ç</div>
              <div class="calendar-day-header">–ü—Ç</div>
              <div class="calendar-day-header weekend">–°–±</div>
              <div class="calendar-day-header weekend">–í—Å</div>
            </div>
            <div id="calendar-grid" class="calendar-grid">
              </div>
          </div>
          
          <div class="legend-container">
            <div class="legend-item"><div class="legend-color personal"></div><span>–õ–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏</span></div>
            <div class="legend-item"><div class="legend-color group"></div><span>–ì—Ä—É–ø–ø–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</span></div>
            <div class="legend-item"><div class="legend-color completed"></div><span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span></div>
            <div class="legend-item"><div class="legend-color today"></div><span>–°–µ–≥–æ–¥–Ω—è</span></div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<div class="modal-overlay task-details-modal" id="taskDetailsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="taskTitle">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h3>
      <button class="modal-close" id="closeTaskDetails">&times;</button>
    </div>
    <div class="modal-body" id="taskDetailsContent">
      </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="editTaskBtn">
        <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
      </button>
      <button class="btn-primary" id="completeTaskBtn">
        <i class="fas fa-check"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay group-modal" id="groupModal">
  <div class="modal-content group-modal">
    <div class="modal-header">
      <h3><i class="fas fa-layer-group"></i> –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
      <button class="modal-close" id="closeGroupModal">&times;</button>
    </div>
    <form method="post" action="{% url 'create_group' %}" id="groupForm">
      {% csrf_token %}
      <div class="form-group">
        <label for="id_name"><i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
        <input type="text" name="name" class="form-control" id="id_name" required>
        <div class="help-text">–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –∑–∞–¥–∞—á</div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelGroupModal"><i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-primary"><i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay task-modal" id="taskModal">
  <div class="modal-content task-modal">
    <div class="modal-header">
      <h3><i class="fas fa-tasks"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
      <button class="modal-close" id="closeTaskModal">&times;</button>
    </div>
    <form method="post" action="{% url 'create_task' %}" id="taskForm">
      {% csrf_token %}
      <div class="form-group">
        <label for="{{ task_form.title.id_for_label }}"><i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
        {{ task_form.title }}
        {% if task_form.title.errors %}<div class="errorlist">{{ task_form.title.errors }}</div>{% endif %}
        <div class="help-text">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ª–∏ –∑–∞–¥–∞—á–∏</div>
      </div>
      <div class="form-group">
        <label for="{{ task_form.description.id_for_label }}"><i class="fas fa-align-left"></i> –û–ø–∏—Å–∞–Ω–∏–µ</label>
        {{ task_form.description }}
      </div>
      <div class="form-group">
        <label for="{{ task_form.discipline.id_for_label }}"><i class="fas fa-book"></i> –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</label>
        {{ task_form.discipline }}
      </div>
      <div class="form-group">
        <label for="{{ task_form.deadline.id_for_label }}"><i class="fas fa-calendar-check"></i> –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
        {{ task_form.deadline }}
        <div class="help-text">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î</div>
      </div>
      <div class="form-group">
        <label for="{{ task_form.group.id_for_label }}"><i class="fas fa-layer-group"></i> –ì—Ä—É–ø–ø–∞</label>
        {{ task_form.group }}
      </div>
      <div class="form-group">
        <label for="{{ task_form.points.id_for_label }}"><i class="fas fa-star"></i> –ë–∞–ª–ª—ã –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
        {{ task_form.points }}
        <div class="help-text">–°–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –ø–æ–ª—É—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelTaskModal"><i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-primary"><i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay group-modal" id="groupModal">
  <div class="modal-content group-modal">
    <div class="modal-header">
      <h3><i class="fas fa-users"></i> –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
      <button class="modal-close" id="closeGroupModal">&times;</button>
    </div>

    <form method="post" action="{% url 'create_group' %}" id="groupForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ group_form.name.id_for_label }}"><i class="fas fa-tag"></i> –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
        {{ group_form.name }}
        {% if group_form.name.errors %}
          <div class="errorlist">{{ group_form.name.errors }}</div>
        {% endif %}
        <div class="help-text">–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–¢-21 –∏–ª–∏ –ü—Ä–æ–µ–∫—Ç –•</div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelGroupModal">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}