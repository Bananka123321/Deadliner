{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/home_logged.css' %}">
  <script defer src="{% static 'js/home_logged.js' %}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard">
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-icon">üöÄ</div>
      <span class="logo-text">TaskFlow</span>
    </div>
    
    <nav class="menu">
      <ul>
        <li class="active" data-section="groups">
          <i class="fas fa-users"></i> <span>–ì—Ä—É–ø–ø—ã</span>
        </li>
        <li data-section="tasks">
          <i class="fas fa-tasks"></i> <span>–ó–∞–¥–∞—á–∏</span>
        </li>
        <li data-section="calendar">
          <i class="fas fa-calendar-alt"></i> <span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span>
        </li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info dropdown">
        <div class="user-avatar">{{ user.username|slice:":1"|upper }}</div>
        <span class="username">{{ user.username }}</span>
        <div class="dropdown-menu">
          <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="logout-btn">–í—ã–π—Ç–∏</button>
          </form>
        </div>
      </div>
    </div>
  </aside>
  <main class="main-content">
    <header class="page-header">
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span class="highlight">{{ user.username }}</span></h1>
      <p class="subtitle">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–¥–∞—á</p>
    </header>

    <!--–°–ï–ö–¶–ò–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò-->
    <div class="stats-grid">
      <div class="stat-card neon-success">
        <div class="stat-icon">‚úî</div>
        <div class="stat-details">
          <span class="stat-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
          <span class="stat-value" id="total-done">{{ total_done }}</span>
        </div>
      </div>

      <div class="stat-card neon-streak">
        <div class="stat-icon">üî•</div>
        <div class="stat-details">
          <span class="stat-label">–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫</span>
          <span class="stat-value" id="current-streak">{{ current_streak }}</span>
        </div>
      </div>

      <div class="stat-card neon-warning">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-details">
          <span class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>
          <span class="stat-value" id="expired">{{ expired }}</span>
        </div>
      </div>
    </div>

    <!--–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–µ–∫—Ü–∏–π-->
    <div class="content-container">
      <!--–°–µ–∫—Ü–∏—è –ì–†–£–ü–ü-->
      <section id="groups-section" class="content-section active">
        <div class="tasks-section">
          <div class="section-header">
            <h2>–í–∞—à–∏ –≥—Ä—É–ø–ø—ã</h2>
            <div class="actions">
              <button class="btn-primary" id="openGroupModal">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
              </button>
            </div>
          </div>

          <div class="tasks-grid">
            {% for group, tasks in group_tasks.items %}
            <div class="task-group clickable" data-href="{% url 'group_detail' group.id %}" data-group-id="{{ group.id }}">
              <div class="group-header">
                <h3>{{ group.name }}</h3>
                <span class="task-count">{{ tasks|length }}</span>
              </div>
              <div class="tasks-list">
                {% for task in tasks %}
                <div class="task-item">
                  <div class="task-content">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-meta">
                      {% if task.discipline %}
                        <span class="discipline">{{ task.discipline }}</span>
                      {% endif %}
                      {% if task.deadline %}
                        <span class="deadline">–¥–æ {{ task.deadline|date:"d.m.Y" }}</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
            
            {% if not group_tasks %}
            <div class="empty-state">
              <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–ø–ø. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –≥—Ä—É–ø–ø—É!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- –°–µ–∫—Ü–∏—è –ó–ê–î–ê–ß -->
      <section id="tasks-section" class="content-section">
        <div class="tasks-section">
          <div class="section-header">
            <h2>–í—Å–µ –∑–∞–¥–∞—á–∏</h2>
            <div class="actions">
              <button class="btn-primary" id="openTaskModal">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
              </button>
            </div>
          </div>
          
          <div class="tasks-list-full">
            {% for group, tasks in group_tasks.items %}
              {% for task in tasks %}
              <div class="task-item">
                <div class="task-content">
                  <div class="task-title">{{ task.title }}</div>
                  <div class="task-meta">
                    {% if task.discipline %}
                      <span class="discipline">{{ task.discipline }}</span>
                    {% endif %}
                    {% if task.deadline %}
                      <span class="deadline">–¥–æ {{ task.deadline|date:"d.m.Y" }}</span>
                    {% endif %}
                    <span class="group">{{ group.name }}</span>
                  </div>
                </div>
              </div>
              {% endfor %}
            {% endfor %}
            
            {% if not group_tasks %}
            <div class="empty-state">
              <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</p>
            </div>
            {% endif %}
          </div>
        </div>
      </section>

      <!--–°–µ–∫—Ü–∏—è –ö–ê–õ–ï–ù–î–ê–†–¨-->
      <section id="calendar-section" class="content-section">
        <div class="calendar-section">
          <div class="section-header">
            <h2><i class="fas fa-calendar-alt me-2"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–¥–∞—á</h2>
            <div class="calendar-controls">
              <button class="calendar-btn" id="prevBtn">
                <i class="fas fa-chevron-left"></i>
              </button>
              <h3 id="currentMonthYear" class="current-period">–ò—é–Ω—å 2026</h3>
              <button class="calendar-btn" id="nextBtn">
                <i class="fas fa-chevron-right"></i>
              </button>
              <div class="view-toggle">
                <button class="view-btn active" data-view="month">
                  <i class="fas fa-calendar-week"></i> –ú–µ—Å—è—Ü
                </button>
                <button class="view-btn" data-view="week">
                  <i class="fas fa-calendar-day"></i> –ù–µ–¥–µ–ª—è
                </button>
              </div>
            </div>
          </div>
          
          <div class="calendar-container">
            <div class="calendar-header">
              <div class="calendar-day-header">–ü–Ω</div>
              <div class="calendar-day-header">–í—Ç</div>
              <div class="calendar-day-header">–°—Ä</div>
              <div class="calendar-day-header">–ß—Ç</div>
              <div class="calendar-day-header">–ü—Ç</div>
              <div class="calendar-day-header weekend">–°–±</div>
              <div class="calendar-day-header weekend">–í—Å</div>
            </div>
            <div id="calendar-grid" class="calendar-grid">
              <!-- –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
          </div>
          
          <div class="task-details-modal" id="taskDetailsModal">
            <div class="modal-content">
              <div class="modal-header">
                <h3 id="taskTitle">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h3>
                <button class="modal-close" id="closeTaskDetails">&times;</button>
              </div>
              <div class="modal-body" id="taskDetailsContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
              </div>
              <div class="modal-footer">
                <button class="btn-secondary" id="editTaskBtn">
                  <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
                <button class="btn-primary" id="completeTaskBtn">
                  <i class="fas fa-check"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
              </div>
            </div>
          </div>
          
          <div class="legend-container">
            <div class="legend-item">
              <div class="legend-color personal"></div>
              <span>–õ–∏—á–Ω—ã–µ –∑–∞–¥–∞—á–∏</span>
            </div>
            <div class="legend-item">
              <div class="legend-color group"></div>
              <span>–ì—Ä—É–ø–ø–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</span>
            </div>
            <div class="legend-item">
              <div class="legend-color completed"></div>
              <span>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
            </div>
            <div class="legend-item">
              <div class="legend-color today"></div>
              <span>–°–µ–≥–æ–¥–Ω—è</span>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<!--–ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ì–†–£–ü–ü-->
<div class="modal-overlay group-modal" id="groupModal">
  <div class="modal-content group-modal">
    <div class="modal-header">
      <h3><i class="fas fa-layer-group"></i> –ù–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</h3>
      <button class="modal-close" id="closeGroupModal">&times;</button>
    </div>

    <form method="post" action="{% url 'create_group' %}" id="groupForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="id_name"><i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
        <input type="text" name="name" class="form-control" id="id_name" required>
        <div class="help-text">–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –∑–∞–¥–∞—á</div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelGroupModal">
          <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" class="btn-primary">
          <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
        </button>
      </div>
    </form>
  </div>
</div>

<!--–ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ó–ê–î–ê–ß-->
<div class="modal-overlay task-modal" id="taskModal">
  <div class="modal-content task-modal">
    <div class="modal-header">
      <h3><i class="fas fa-tasks"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h3>
      <button class="modal-close" id="closeTaskModal">&times;</button>
    </div>

    <form method="post" action="{% url 'create_task' %}" id="taskForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="{{ task_form.title.id_for_label }}"><i class="fas fa-heading"></i> –ù–∞–∑–≤–∞–Ω–∏–µ</label>
        {{ task_form.title }}
        {% if task_form.title.errors %}
          <div class="errorlist">{{ task_form.title.errors }}</div>
        {% endif %}
        <div class="help-text">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ª–∏ –∑–∞–¥–∞—á–∏</div>
      </div>

      <div class="form-group">
        <label for="{{ task_form.description.id_for_label }}"><i class="fas fa-align-left"></i> –û–ø–∏—Å–∞–Ω–∏–µ</label>
        {{ task_form.description }}
        {% if task_form.description.errors %}
          <div class="errorlist">{{ task_form.description.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ task_form.discipline.id_for_label }}"><i class="fas fa-book"></i> –î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</label>
        {{ task_form.discipline }}
        {% if task_form.discipline.errors %}
          <div class="errorlist">{{ task_form.discipline.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ task_form.deadline.id_for_label }}"><i class="fas fa-calendar-check"></i> –°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
        {{ task_form.deadline }}
        {% if task_form.deadline.errors %}
          <div class="errorlist">{{ task_form.deadline.errors }}</div>
        {% endif %}
        <div class="help-text">–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î</div>
      </div>

      <div class="form-group">
        <label for="{{ task_form.group.id_for_label }}"><i class="fas fa-layer-group"></i> –ì—Ä—É–ø–ø–∞</label>
        {{ task_form.group }}
        {% if task_form.group.errors %}
          <div class="errorlist">{{ task_form.group.errors }}</div>
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ task_form.points.id_for_label }}"><i class="fas fa-star"></i> –ë–∞–ª–ª—ã –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</label>
        {{ task_form.points }}
        {% if task_form.points.errors %}
          <div class="errorlist">{{ task_form.points.errors }}</div>
        {% endif %}
        <div class="help-text">–°–∫–æ–ª—å–∫–æ –±–∞–ª–ª–æ–≤ –ø–æ–ª—É—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ</div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="cancelTaskModal">
          <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" class="btn-primary">
          <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
        </button>
      </div>
    </form>
  </div>
</div>

{% endblock %}