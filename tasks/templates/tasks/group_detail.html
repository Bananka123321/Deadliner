{% extends "base.html" %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static 'css/group_detail.css' %}">
  <script defer src="{% static 'js/group_detail.js' %}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard">
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">üöÄ</div>
            <span class="logo-text">DeadLiner</span>
        </div>
        <nav class="menu">
            <ul>
                <li class="active"><i class="fas fa-users"></i> <span>–û–±—â–µ–µ</span></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info dropdown">
                <div class="user-avatar">{{ user.username|slice:":1"|upper }}</div>
                <span class="username">{{ user.username }}</span>
                <div class="dropdown-menu">
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="logout-btn">–í—ã–π—Ç–∏</button>
                    </form>
                </div>
            </div>
        </div>
    </aside>
    <main class="main-content">
        <div class="page-header">
            <h1>{{ group.name }}</h1>
        </div>
        <div class="stats-grid">
            <div class="stat-card neon-success">
                <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                <div class="stat-details">
                    <span class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–∏</span>
                    <span class="stat-value">{{ group.members.count }}</span>
                </div>
            </div>
            <div class="stat-card neon-streak">
                <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                <div class="stat-details">
                    <span class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</span>
                    <span class="stat-value">7</span>
                </div>
            </div>
            <div class="stat-card neon-warning" id="leaders-card" style="cursor:pointer;">
                <div class="stat-icon"><i class="fas fa-award"></i></div>
                <div class="stat-details">
                    <span class="stat-label">–õ–∏–¥–µ—Ä –º–µ—Å—è—Ü–∞</span>
                    <span class="stat-value">
                        {% if leaderboard %}
                            {{ leaderboard.0.user.username }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        <div class="tasks-section">
            <div class="section-header">
            <h2>–ó–∞–¥–∞—á–∏ –≥—Ä—É–ø–ø—ã</h2>
            {% if request.user in group.members %}
            <button class="btn-primary" id="openTaskModal">
                <i class="fas fa-plus"></i> –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞
            </button>
            {% endif %}
        </div>

        {% if tasks %}
            <div class="tasks-grid">
            {% for user_task in tasks %}
                {% with task=user_task.task %}
                <div class="task-group {% if not task.group %}personal{% endif %}">
                    <div class="group-header">
                    <h3>{{ task.title }}</h3>
                    <span class="task-count">
                        {% if user_task.is_done %}
                        <i class="fas fa-check-circle text-green-500"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                        {% else %}
                        <i class="fas fa-clock text-yellow-500"></i> –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                        {% endif %}
                    </span>
                    </div>
                    <div class="tasks-list">
                    <div class="task-item">
                        <div class="task-content">
                        <div class="task-title">{{ task.title }}</div>
                        <div class="task-meta">
                            {% if task.discipline %}
                            <span class="discipline">{{ task.discipline }}</span>
                            {% endif %}
                            {% if task.deadline %}
                            <span class="deadline">–¥–æ {{ task.deadline|date:"d.m.Y H:i" }}</span>
                            {% endif %}
                            <span class="points">‚òÖ {{ task.points }}</span>
                        </div>
                        {% if task.description %}
                            <div class="task-description mt-2" style="font-size:0.9rem; color:#94a3b8;">
                            {{ task.description }}
                            </div>
                        {% endif %}
                        </div>
                    </div>
                    </div>
                </div>
                {% endwith %}
            {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
            <p>–í —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–¥–∞—á.</p>
            </div>
            {% endif %}
    <div class="modal-overlay" id="leaders-modal">
        <div class="modal-content">
            <button class="modal-close" id="leaders-close">&times;</button>
            <h2>–¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>

            <table style="width:100%; border-collapse: collapse; margin-top: 1rem;">
                <thead>
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.15);">
                        <th style="text-align:left; padding: 8px 0;">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                        <th style="text-align:right; padding: 8px 0;">–û—á–∫–∏</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in leaderboard %}
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                        <td style="padding: 8px 0;">{{ s.user.username }}</td>
                        <td style="text-align:right; padding: 8px 0; font-weight:700;">{{ s.total_points }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" style="padding: 10px 0;">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="add-member-section">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
    <form id="addMemberForm" data-group-id="{{ group.id }}">
        <div class="form-group">
        <input type="text" id="usernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º..." maxlength="150">
        <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        <div id="memberMessage" class="message"></div>
    </form>

    <div class="members-list">
        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ group.members.count }}):</h4>
        {% for member in group.members.all %}
        <div class="member-item">{{ member.username }}</div>
        {% endfor %}
    </div>
    </div>
    </main>
</div>
{% endblock %}
